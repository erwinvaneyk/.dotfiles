#!/usr/bin/env bash

set -e

function abspath {
    local target="$1"

    if [ "$target" == "." ]; then
        echo "$(pwd)"
    elif [ "$target" == ".." ]; then
        echo "$(dirname "$(pwd)")"
    else
        echo "$(cd "$(dirname "$1")"; pwd)/$(basename "$1")"
    fi
}

DOTFILES_ROOT="${DOTFILES_ROOT:-${HOME}/dotfiles}"

if [ -z "$1" ]; then
  printf "usage: dotfiles <file-to-sync>\n"
  exit 1;
fi

# Check if valid target to sync
if [ ! -z $(readlink ${path}) ]; then
  printf "cannot sync link"
  exit 2;
fi

path=$(abspath $1)
newpath=${DOTFILES_ROOT}/$(basename ${path})
cp ${path} ${newpath}

# TODO Check if already synced
link_cmd="ln -s ${newpath} ${path}"
echo ${link_cmd}  >> ${DOTFILES_ROOT}/links.sh 

# Setup link
rm ${path}
eval ${link_cmd}

echo "${path} ~ ${newpath}"
